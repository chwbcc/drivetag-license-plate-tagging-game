# Database Schema Reference

This document defines the expected database schema for the application.

## IMPORTANT: User ID Management

**All user IDs must be generated using the `generateUserId()` function from `@/utils/generate-id`.**
- User IDs follow the format: `usr_<timestamp>_<random>`
- Example: `usr_1737259200000_abc123xyz`
- This ensures consistency across all tables and prevents ID conflicts

**Foreign Key Relationships:**
- All `created_by` and `targetuserid` fields in pellets table reference `users.id`
- All `userid` fields in badges and activities tables reference `users.id`
- These foreign keys enforce data integrity and cascade deletes

## Users Table
```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  username TEXT,
  name TEXT,
  photo TEXT,
  license_plate TEXT,
  state TEXT,
  created_at BIGINT,
  role TEXT DEFAULT 'user',
  experience INTEGER DEFAULT 0,
  level INTEGER DEFAULT 1,
  negative_pellet_count INTEGER DEFAULT 10,
  positive_pellet_count INTEGER DEFAULT 5,
  positive_rating_count INTEGER DEFAULT 0,
  negative_rating_count INTEGER DEFAULT 0,
  pellets_given_count INTEGER DEFAULT 0,
  positive_pellets_given_count INTEGER DEFAULT 0,
  negative_pellets_given_count INTEGER DEFAULT 0,
  badges TEXT DEFAULT '[]'
);
```

**Key Points:**
- `id` uses format `usr_<timestamp>_<random>` generated by `generateUserId()`
- All column names use snake_case (e.g., `license_plate`, not `licensePlate`)
- `badges` is stored as JSON string
- Default pellet counts: 10 negative, 5 positive
- All rating and given counts default to 0

## Pellets Table
```sql
CREATE TABLE pellets (
  id TEXT PRIMARY KEY,
  license_plate TEXT NOT NULL,
  targetuserid TEXT,
  created_by TEXT NOT NULL,
  created_at BIGINT NOT NULL,
  notes TEXT,
  type TEXT NOT NULL,
  latitude REAL,
  longitude REAL
);
```

**Key Points:**
- `id` uses format `plt_<timestamp>_<random>` generated by `generatePelletId()`
- `license_plate` stores the target's license plate
- `targetuserid` is NULL if the user is not registered
- `created_by` is the user ID who created the pellet
- `notes` stores the reason/description
- `type` is either 'positive' or 'negative'

## Badges Table
```sql
CREATE TABLE badges (
  id TEXT PRIMARY KEY,
  userid TEXT NOT NULL,
  badgeid TEXT NOT NULL,
  earned_at BIGINT NOT NULL,
  CONSTRAINT fk_badges_userid FOREIGN KEY (userid) REFERENCES users(id) ON DELETE CASCADE
);
```

**Key Points:**
- `id` uses format `bdg_<timestamp>_<random>` generated by `generateBadgeId()`
- `userid` references `users.id` with CASCADE delete

## Activities Table
```sql
CREATE TABLE activities (
  id TEXT PRIMARY KEY,
  userid TEXT NOT NULL,
  actiontype TEXT NOT NULL,
  actiondata TEXT,
  created_at BIGINT NOT NULL,
  CONSTRAINT fk_activities_userid FOREIGN KEY (userid) REFERENCES users(id) ON DELETE CASCADE
);
```

**Key Points:**
- `id` uses format `act_<timestamp>_<random>` generated by `generateActivityId()`
- `userid` references `users.id` with CASCADE delete

## Important Notes

1. **ID Generation**: Always use functions from `@/utils/generate-id`:
   - `generateUserId()` for user IDs
   - `generatePelletId()` for pellet IDs
   - `generateBadgeId()` for badge IDs
   - `generateActivityId()` for activity IDs

2. **Foreign Keys**: The schema enforces referential integrity:
   - Pellets: `created_by` and `targetuserid` must reference valid user IDs
   - Badges: `userid` must reference a valid user ID
   - Activities: `userid` must reference a valid user ID
   - Deleting a user cascades to their pellets, badges, and activities

3. **Column Naming**: All column names should be in lowercase with underscores (snake_case)

4. **User Authentication**: 
   - Login always fetches the user from the database (no hardcoded IDs)
   - Super admin has a consistent ID: `usr_super_admin_1`
   - Registration generates a new unique user ID

5. **Data Consistency**:
   - User counts should be initialized properly when creating users
   - Make sure RLS (Row Level Security) policies allow proper access
   - All user stats are stored and retrieved from the database
